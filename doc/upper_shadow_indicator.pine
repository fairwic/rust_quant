//@version=5
indicator(shorttitle="SI", title="Shadow Indicator", overlay=true)

// è¾“å…¥å‚æ•°
upper_shadow_ratio = input.float(0.6, title="ä¸Šå½±çº¿å æ¯”é˜ˆå€¼", minval=0.1, maxval=0.9, step=0.05)
lower_shadow_ratio = input.float(0.6, title="ä¸‹å½±çº¿å æ¯”é˜ˆå€¼", minval=0.1, maxval=0.9, step=0.05)
volume_threshold = input.float(5000, title="æˆäº¤é‡é˜ˆå€¼", minval=100)
price_amplitude_threshold = input.float(0.5, title="ä»·æ ¼æŒ¯å¹…é˜ˆå€¼", minval=0.1, step=0.1)
show_percentage = input.bool(true, title="æ˜¾ç¤ºç™¾åˆ†æ¯”")
upper_signal_color = input.color(color.red, title="ä¸Šå½±çº¿ä¿¡å·é¢œè‰²")
lower_signal_color = input.color(color.green, title="ä¸‹å½±çº¿ä¿¡å·é¢œè‰²")
label_size = input.string("normal", title="æ ‡ç­¾å¤§å°", options=["tiny", "small", "normal", "large"])

// å­—ç¬¦ä¸²è½¬å¸¸é‡
label_size_const = label_size == "tiny" ? size.tiny : 
                   label_size == "small" ? size.small : 
                   label_size == "normal" ? size.normal : 
                   size.large

// è®¡ç®—ä¸Šå½±çº¿å’Œä¸‹å½±çº¿é•¿åº¦
upper_shadow = high - math.max(open, close)  // ä¸Šå½±çº¿é•¿åº¦
lower_shadow = math.min(open, close) - low   // ä¸‹å½±çº¿é•¿åº¦
total_range = high - low                     // Kçº¿æ€»é«˜åº¦

// è®¡ç®—ä¸Šå½±çº¿å’Œä¸‹å½±çº¿å æ¯”
upper_shadow_percentage = total_range > 0 ? upper_shadow / total_range : 0
lower_shadow_percentage = total_range > 0 ? lower_shadow / total_range : 0

// è®¡ç®—å¼€ç›˜ä»·ä¸æ”¶ç›˜ä»·çš„æŒ¯å¹…
price_amplitude = math.abs(close - open)

// é¢å¤–æ¡ä»¶ï¼šæˆäº¤é‡å¤§äºé˜ˆå€¼ æˆ– ä»·æ ¼æŒ¯å¹…å¤§äºé˜ˆå€¼
volume_condition = volume > volume_threshold
amplitude_condition = price_amplitude > price_amplitude_threshold
additional_condition = volume_condition or amplitude_condition

// ä¸Šå½±çº¿ä¿¡å·æ¡ä»¶ï¼šä¸Šå½±çº¿ > ä¸‹å½±çº¿ ä¸” ä¸Šå½±çº¿å æ¯” > é˜ˆå€¼ ä¸” æ»¡è¶³é¢å¤–æ¡ä»¶
upper_shadow_condition = upper_shadow > lower_shadow and upper_shadow_percentage >= upper_shadow_ratio and additional_condition

// ä¸‹å½±çº¿ä¿¡å·æ¡ä»¶ï¼šä¸‹å½±çº¿ > ä¸Šå½±çº¿ ä¸” ä¸‹å½±çº¿å æ¯” > é˜ˆå€¼ ä¸” æ»¡è¶³é¢å¤–æ¡ä»¶
lower_shadow_condition = lower_shadow > upper_shadow and lower_shadow_percentage >= lower_shadow_ratio and additional_condition

// å½“ä¸Šå½±çº¿æ¡ä»¶æ»¡è¶³æ—¶ï¼Œåˆ›å»ºæ ‡ç­¾æ˜¾ç¤ºä¿¡å·
if upper_shadow_condition
    // å‡†å¤‡æ˜¾ç¤ºæ–‡æœ¬
    base_text = show_percentage ? 
                "ğŸ”» " + str.tostring(upper_shadow_percentage * 100, "#") + "%" : 
                "ğŸ”» ä¸Šå½±çº¿ä¿¡å·"
    
    // æ·»åŠ è§¦å‘æ¡ä»¶ä¿¡æ¯
    condition_text = volume_condition ? " V:" + str.tostring(volume, "#") : 
                     amplitude_condition ? " A:" + str.tostring(price_amplitude, "#.##") : ""
    
    display_text = base_text + condition_text
    
    // åˆ›å»ºæ ‡ç­¾
    label.new(bar_index, high, display_text, 
              color=upper_signal_color, 
              style=label.style_label_down, 
              textcolor=color.white, 
              size=label_size_const)

// å½“ä¸‹å½±çº¿æ¡ä»¶æ»¡è¶³æ—¶ï¼Œåˆ›å»ºæ ‡ç­¾æ˜¾ç¤ºä¿¡å·
if lower_shadow_condition
    // å‡†å¤‡æ˜¾ç¤ºæ–‡æœ¬
    base_text = show_percentage ? 
                "ğŸ”º " + str.tostring(lower_shadow_percentage * 100, "#") + "%" : 
                "ğŸ”º ä¸‹å½±çº¿ä¿¡å·"
    
    // æ·»åŠ è§¦å‘æ¡ä»¶ä¿¡æ¯
    condition_text = volume_condition ? " V:" + str.tostring(volume, "#") : 
                     amplitude_condition ? " A:" + str.tostring(price_amplitude, "#.##") : ""
    
    display_text = base_text + condition_text
    
    // åˆ›å»ºæ ‡ç­¾
    label.new(bar_index, low, display_text, 
              color=lower_signal_color, 
              style=label.style_label_up, 
              textcolor=color.white, 
              size=label_size_const)

// å¯é€‰ï¼šåœ¨å‰¯å›¾æ˜¾ç¤ºå½±çº¿å æ¯”
// å¦‚æœæƒ³åœ¨å‰¯å›¾æ˜¾ç¤ºå æ¯”å˜åŒ–ï¼Œå¯ä»¥å–æ¶ˆä¸‹é¢çš„æ³¨é‡Š
// plot(upper_shadow_percentage * 100, title="ä¸Šå½±çº¿å æ¯”%", color=color.red, linewidth=2)
// plot(lower_shadow_percentage * 100, title="ä¸‹å½±çº¿å æ¯”%", color=color.green, linewidth=2)
// hline(upper_shadow_ratio * 100, title="ä¸Šå½±çº¿é˜ˆå€¼çº¿", color=color.red, linestyle=hline.style_dashed)
// hline(lower_shadow_ratio * 100, title="ä¸‹å½±çº¿é˜ˆå€¼çº¿", color=color.green, linestyle=hline.style_dashed)

// èƒŒæ™¯é«˜äº®ï¼ˆå¯é€‰ï¼‰
bgcolor(upper_shadow_condition ? color.new(upper_signal_color, 90) : lower_shadow_condition ? color.new(lower_signal_color, 90) : na, title="ä¿¡å·èƒŒæ™¯")

// å¯é€‰ï¼šç»˜åˆ¶å½±çº¿æ¯”ä¾‹çº¿
// plot(upper_shadow_percentage - lower_shadow_percentage, title="å½±çº¿å·®å€¼", color=color.blue, linewidth=1)

// å¯é€‰ï¼šæ˜¾ç¤ºå½“å‰æˆäº¤é‡å’Œä»·æ ¼æŒ¯å¹…ä¿¡æ¯
// plotchar(volume, title="æˆäº¤é‡", char="", location=location.top, color=color.blue, size=size.tiny)
// plotchar(price_amplitude, title="ä»·æ ¼æŒ¯å¹…", char="", location=location.top, color=color.orange, size=size.tiny) 