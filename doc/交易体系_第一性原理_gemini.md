档

---

## 前言：系统哲学

本交易系统是为高流动性的加密货币市场（如 BTC/ETH）设计的一套**全周期、风险优先、多层次决策**的自动化交易框架。

其构建遵循**第一性原理**，从市场的根本驱动力出发，旨在通过严谨的量化规则，在复杂的市场环境中捕捉确定性相对较高的边际优势。

**系统的核心哲学基于三大基石：**

1.  **风险是唯一可控的变量：** 盈利来自市场，但亏损源于自身。本系统将资金管理和风险控制置于最高优先级，所有交易决策都必须在风控框架内进行。
2.  **市场状态决定策略选择：** 不存在万能的策略。系统首先识别当前市场处于“趋势”还是“震荡”，是“牛市”还是“熊市”，然后调用与之匹配的策略模块，以求“顺势而为”。
3.  **多周期共振过滤伪信号：** 市场的噪音巨大，单一时间框架的信号往往是陷阱。本系统采用（日线、4小时、1小时）三层周期共振原则，大周期定方向，中周期找区域，小周期精确定位，层层过滤，只执行高置信度的交易。

本文件旨在成为该交易体系的最终执行规范，其所有规则均需被代码严格、无条件地执行。

---

## 一、核心假设与盈利逻辑

### 1.1 市场非效率假设
- **信息不对称**：高波动时段，订单簿深度信息滞后，价格瞬时偏离公允价值。
- **流动性碎片化**：不同交易所或合约的深度分布不均，存在跨市场套利空间。
- **行为金融学**：大额持仓者的行为（如在关键价位压制或放量）会触发止损/止盈的链式反应，导致价格的超调。

### 1.2 边际优势来源
| 策略类型 | 核心逻辑 | 失效条件 |
|---|---|---|
| **趋势捕获** | 利用多周期均线（EMA）共振，捕捉持续性高于随机波动的趋势行情。 | ADX < 20 且布林带宽持续处于极低水平（< 3%）。 |
| **假突破过滤** | 通过布林带、成交量和K线形态进行三重过滤，在假突破发生后进行逆向操作。 | 成交量出现极端异常（如 > 均量×3 或 < 均量×0.2）。 |
| **风险对冲** | 通过动态调节杠杆与仓位，确保单笔风险严格受控，以实现长期正期望。 | 连续亏损达到风控阈值，触发暂停机制。 |

### 1.3 盈利模型
1.  **趋势跟踪**：在多周期均线同向排列时，于回调至关键EMA支撑/阻力位时挂单。
2.  **均值回归**：在识别到假突破或极端超买/超卖的K线形态后，建立反向仓位。
3.  **事件驱动**：在重大宏观事件前后，利用信息发布带来的短期波动性进行对冲挂单。

### 1.4 失效边界
> **系统生存原则**：当市场微观结构恶化时，系统必须自动停用以规避未知风险。

| 条件 | 阈值 | 动作 |
|---|---|---|
| 点差过大 | > 0.1% 持续 30 分钟 | 停用该交易品种 |
| 深度不足 | < 5 万 USDT 持续 30 分钟 | 停用该交易品种 |
| 规则触发率过低 | 最近 100 笔信号中，有效触发率 < 20% | 规则失效，转为仅执行资金管理 |
| 宏观趋势逆转 | 日线 EMA 多转空，且 4H/1H 周期同向确认 | 清空所有趋势仓位，并大幅降低杠杆 |

---

## 二、数据口径与基础参数

### 2.1 基础定义
- **时区与频率**：默认使用 `UTC` 时区，日线收盘于 `00:00 UTC`。未特殊注明时，所有计算均基于 `1H` K线。
- **价格口径**：
    - `收盘价`：最新完成的K线收盘价。
    - `公允价`：`(bid1 + ask1) / 2`，用于市价单执行和滑点检查。
- **成交量口径**：
    - `永续合约`：报价货币的等值 USDT。
    - `现货`：基础货币的数量。

### 2.2 数据质量规则
- **数据缺失**：若连续缺失 ≥ 1 根K线，该缺口时段内不进行任何计算或交易，不使用插值。
- **价格跳空**：单根K线跳幅 > 10% 且成交量异常，则该K线产生的所有信号均作废。
- **信号确认**：形态、背离、假突破等信号，需要后续 **1 根** K线的走势进行确认。多周期排列需连续 **2 根** K线收盘后均满足条件。
- **信号时效**：入场信号发出后，若在 **3 根** K线内未成交，则该信号失效并撤单。

### 2.3 指标参数
| 指标 | 别名/参数 | 最小样本要求 |
|---|---|---|
| **EMA** | `ema1` (12), `ema2` (144), `ema3` (169), `ema4` (576), `ema5` (676) | 200 根 K |
| **Bollinger Bands** | (20, 2) | 20 根 K |
| **ADX** | 14 | 14 根 K |
| **ATR** | 14 | 14 根 K |
| **RSI** | 14 | 14 根 K |
| **MACD** | (12, 26, 9) | 35 根 K |

---

## 三、资金管理体系

> **第一铁律**：系统的任何规则都不能凌驾于资金管理规则之上。在任何时候，生存都是首要任务。

### 3.1 单笔风险敞口
| 账户状态 | 风险上限（占总净值） | 说明 |
|---|---|---|
| 正常 | **2%** | 单笔交易允许的最大亏损。 |
| 连续亏损 2 次 | 1% | 风险降档。 |
| 连续亏损 4 次 | 0.5% | 进入保护模式。 |
| 连续亏损 6 次 | **暂停交易** | 强制冷却 24 小时，并触发人工复盘。 |

### 3.2 仓位计算
```
理论仓位 = (总净值 × 风险比例) / |入场价 - 止损价 - 滑点保护| × 入场价
实际仓位 = min(理论仓位, 总净值 × 单品种仓位上限)
```
- **滑点保护**：默认 `0.1%`。
- **手续费**：按双边 `0.04%` 计入成本。
- **杠杆**：实际杠杆由仓位和保证金决定，且不得超过交易所限制。在重大事件窗口或熔断期间，杠杆上限自动减半。

### 3.3 账户熔断与恢复
| 级别 | 触发条件 | 处理措施 | 恢复条件 |
|---|---|---|---|
| **一级预警** | 日亏损 ≥ 3% | 仓位减半，杠杆降一档。 | 回撤 < 1.5% 且连续 3 日净值为正。 |
| **二级预警** | 周亏损 ≥ 8% | **停止所有新开仓**，只允许减仓。 | 回撤 < 4% 且连续 3 日净值为正。 |
| **三级熔断** | 月亏损 ≥ 15% | **立即停止交易**，进行全面复盘。 | 回撤 < 7.5% 并通过人工审核。 |
| **绝对熔断** | 总回撤 ≥ 25% | **清空所有仓位，系统完全暂停**。 | 至少冷却 7 天，完成复盘报告并通过人工确认。 |

- **恢复后**：进入为期 3 日的保护期，期间仓位上限减半、禁止加仓。

### 3.4 盈利管理
> **系统目标**：将账面浮盈转化为实际利润，实现长期复利。

| 盈利阶段 | 处理规则 |
|---|---|
| 累计盈利 +20% | 提取 10% 利润至冷钱包。 |
| 累计盈利 +50% | 提取本金的 50%。 |
| 累计盈利 +100% | **提取全部本金**，之后完全用利润进行交易。 |

---

## 四、环境识别层

> **第二铁律**：正确识别当前的市场环境，是选择正确策略的先决条件。

### 4.1 宏观周期识别（方向偏好）
基于日线级别的 EMA 排列定义宏观的牛熊周期，此判断优先于任何短周期技术信号。
| 周期阶段 | 杠杆偏向 | 做多杠杆上限 | 做空杠杆上限 |
|---|---|---|---|
| **熊市** (日线空头排列) | 偏空 | 3× | 5× |
| **牛市** (日线多头排列) | 偏多 | 5× | 3× |

### 4.2 市场阶段策略（趋势/震荡）
#### 震荡市判定（需同时满足）
1.  `ADX(14) < 25`
2.  布林带宽 `(20,2) < 4%`
3.  `ema2`, `ema3`, `ema4` 两两之间距离 < 1%
4.  近 20 根 K线的高低点振幅 < 8%

#### 趋势/震荡 EMA 排列定义
| EMA 距离 | 判定 |
|---|---|
| < 1% | **缠绕** (明确的震荡市) |
| 1% - 2% | **过渡区** (方向不明，按大周期方向处理或观望) |
| > 2% | **明确趋势** (执行趋势策略) |

### 4.3 市场阶段的精细化策略
| 市场阶段 | 特征 | 策略偏向 | 仓位上限 |
|---|---|---|---|
| **熊市初期** | 高位放量下跌 | 强空，禁止逆势 | 30% |
| **熊市中期** | 持续阴跌，反弹无力 | 偏空，可轻仓抢反弹 | 50% |
| **牛市中期** | 趋势确立，回调即买入 | 强多，回调加仓 | 70% |
| **牛熊后期** | 加速上涨/下跌，情绪狂热 | 中性偏多/空，降低杠杆，分批止盈 | 50% |

---

## 五、信号生成层

> **第三铁律**：信号必须经过多重、独立的过滤器验证，单一维度的信号不足为信。

### 5.1 多周期共振原则
| 日线 (1D) | 4H | 1H | 操作 | 仓位系数 |
|---|---|---|---|---|
| 多头 | 多头 | 多头信号 | **做多** | **100%** |
| 多头 | 空头 | 多头信号 | 做多 (视为反弹) | 50% |
| 空头 | 空头 | 空头信号 | **做空** | **100%** |
| 空头 | 多头 | 空头信号 | 做空 (视为回调) | 50% |
| **方向冲突** | - | - | **不操作或观望** | - |

- **周期冲突处理**：小周期服从大周期。当日线与4H方向冲突时，跟随日线方向，逆向仓位的仓位减半、止盈目标减半、禁止加仓。

### 5.2 趋势排列策略 (EMA2, EMA3, EMA4 同向)
此策略适用于多头排列 (`ema2 > ema3 > ema4`) 和空头排列 (`ema2 < ema3 < ema4`) 的市场。
- **杠杆配置**：顺势方向 `5×`，逆势方向 `3×`。
- **核心入场点**：
    1.  **大振幅K线挂单**：当出现振幅 ≥ 3% 的顺势K线时，在回调至 `(高点-收盘价)` 或 `(收盘价-低点)` 的 `0.382` 斐波那契位置挂单。
    2.  **假突破市价单**：当出现逆势的假突破信号时，直接市价追单。
- **通用过滤器（任一触发则信号作废）**：
    - **EMA 距离过滤**：当 `ema2` 与 `ema4` 距离 > 5% 时，若收盘价反向穿越 `ema3`，视为假信号。
    - **成交量过滤**：信号K线出现前的3根K线成交量持续递减，忽略逆势操作信号。
    - **布林带过滤**：K线已触碰布林带上/下轨，忽略顺势追单信号，防止追在短期顶部/底部。

### 5.3 核心信号形态定义
#### 假突破（用于逆向操作）
- **看涨假突破 (用于做空)**：
    1.  K线最高价突破前20根K线高点。
    2.  收盘价回落至前高下方，且上影线 ≥ 实体 × 1.5。
    3.  成交量 > 前3根均量 × 1.2。
- **看跌假突破 (用于做多)**：
    1.  K线最低价跌破前20根K线低点。
    2.  收盘价回升至前低上方，且下影线 ≥ 实体 × 1.5。
    3.  成交量 > 前3根均量 × 1.2。

#### 背离（用于趋势衰竭预警）
- **底背离 (看涨)**：价格创新低，但 `RSI` 未创新低，且 `MACD` 柱状图缩短或金叉。
- **顶背离 (看空)**：价格创新高，但 `RSI` 未创新高，且 `MACD` 柱状图缩短或死叉。

---

## 六、订单执行与风险管理

### 6.1 订单执行层
| 场景 | 价格锚点 | 保护措施 |
|---|---|---|
| **限价挂单** | 公允价 ± 0.05% (向有利方向) | 若盘口深度 < 5万 USDT，仓位减半。 |
| **市价单** | 公允价 | 执行价格与公允价偏离 ≤ 0.15%，超出则撤单重试。 |
| **执行前检查** | - | 若盘口点差 > 0.08%，禁止入场。 |
- **挂单时效**：3 根 K 线内未成交则自动撤单。
- **失败处理**：下单失败后，以指数退避（200ms）重试2次，若连续失败，则标记该品种在30分钟内“不可交易”。
- **连接监控**：WebSocket/REST API 断连或时钟漂移 > 200ms，暂停所有交易活动。

### 6.2 风险管理层（止损与止盈）
#### 止损体系 (优先级由高到低)
| 类型 | 计算方式 | 适用场景 |
|---|---|---|
| **1. 结构止损** | 前一波段高/低点 ± 0.3% 缓冲 | 关键支撑/阻力位的入场。 |
| **2. ATR 止损** | 入场价 ± 1.5 × ATR(14) | 趋势行情中的常规止损。 |
| **3. 固定比例止损**| 入场价 ± 2% | 消息面博弈或无明显结构时。 |

#### 移动止损 (R = 初始风险单位)
| 盈利阶段 | 止损调整 |
|---|---|
| ≥ 1R | 移至保本位 (覆盖手续费)。 |
| ≥ 1.5R | 移至 +0.5R 盈利位。 |
| ≥ 2R | 启用 `ATR(14) × 1.0` 跟踪止损。 |
| ≥ 3R | 收紧至 `ATR(14) × 0.8` 跟踪止损。 |

#### 分批止盈
| 到达目标 | 平仓比例 | 剩余仓位止损调整 |
|---|---|---|
| **目标1 (1.5R-2R)**| 40% | 移至保本位。 |
| **目标2 (2R-4R)** | 30% | 移至目标1价格。 |
| **目标3** | 剩余30% | 持续以ATR跟踪，直至止损。 |

#### 时间止损
- **趋势市**：持仓超过 48 根 K 线仍未到达目标1，则平仓。
- **震荡市**：持仓超过 12 根 K 线仍未到达目标1，则平仓。
- **附加规则**：持仓 12 根 K 线后仍处于浮亏状态，减仓 50%。

---

## 七、特殊策略：事件驱动与震荡市

### 7.1 事件驱动策略
适用于美联储决议、CPI/非农数据等高波动性事件。
| 规则 | 参数 |
|---|---|
| **禁止窗口** | 事件前后 15 分钟，若市场恶化则延长。 |
| **杠杆上限** | 2.5× |
| **仓位上限** | 30% |
| **时间止损** | 事件发生后 3 根 K 线内未达盈利目标，则立即平仓。 |
| **禁止操作** | 禁止加仓、网格等摊薄成本的行为。 |

### 7.2 震荡市策略
在满足“震荡市判定”条件时启用。
| 规则 | 参数 |
|---|---|
| **杠杆上限** | 2-3× |
| **仓位上限** | ≤ 30% |
| **止盈目标** | 1-1.5R，不追求大利润。 |
| **操作** | 在区间上沿配合看跌信号做空，在区间下沿配合看涨信号做多。**严禁在区间中部操作**。 |
- **突破识别**：当价格放量突破区间，且ADX上升，下一根K线未跌回时，视为“震荡转趋势”，切换至趋势策略。

---

## 八、复盘与迭代体系

### 8.1 复盘周期与内容
| 周期 | 内容 |
|---|---|
| **日复盘** | 检查交易日志，评估执行质量，有无偏离规则。 |
| **周复盘** | 统计关键绩效指标（KPI），分析主要盈亏来源。 |
| **月复盘** | 分析特定策略在当月环境下的表现，考虑是否需要微调参数。 |
| **季复盘** | 评估整个系统，进行重大调整或策略增删。 |

### 8.2 关键绩效指标 (KPI)
| 指标 | 健康值 | 预警值 (触发深度分析) |
|---|---|---|
| **胜率** | ≥ 40% | < 35% |
| **盈亏比** | ≥ 2:1 | < 1.5:1 |
| **最大回撤** | < 15% | > 20% |
| **夏普比率** | > 1.5 | < 1.0 |

### 8.3 策略调整流程
1.  **触发**：当KPI进入预警值，或连续10笔交易胜率<30%。
2.  **暂停**：暂停该策略的新开仓。
3.  **分析**：导出近期交易，分析亏损的共同特征，识别是规则漏洞、参数不适、还是市场环境变化。
4.  **测试**：提出修正方案后，以极小仓位进行实盘测试（至少20笔交易）。
5.  **恢复**：测试验证通过后，恢复正常运行。

---

## 九、规则优先级与冲突决策

> **最终裁决**：当规则发生冲突时，遵循“风险优先、大周期优先、过滤优先”的元规则。

| 优先级 | 规则类型 | 说明 |
|---|---|---|
| **P0 (最高)** | **资金管理** | 账户熔断、单笔风险敞口等规则，拥有绝对否决权。 |
| **P1** | **环境识别** | 宏观周期、趋势/震荡判断，决定了采用哪一套策略。 |
| **P2** | **多周期共振** | 大周期的方向拥有对小周期的否决权。 |
| **P3** | **假信号过滤** | 任何过滤条件被触发，都将使原始信号作废。 |
| **P4** | **入场与执行** | 具体的入场点、挂单方式和执行检查。 |
| **P5 (最低)** | **止盈与跟踪** | 风险控制的最后环节。 |
