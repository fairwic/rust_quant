# 交易体系（第一性原理·重构版）

> 目的：把“为什么能赚钱、何时不该交易、如何稳定执行”写成可落地、可审计、可迭代的体系说明，而不是堆规则。
>
> 适用读者：自己/团队的策略研发、执行与风控；需要把策略从“想法”落到“系统”的人。

---

## 快速使用（读者路径 + 一页总览）

### 读者路径（按角色读）
- **策略研发/量化（建议顺序）**：先读“快速使用”→ 直接读前置的“实现规格（附录 A-D）”→ 再顺序读 `1→2→3→4→5→6→7→8→10→11→12`；`13` 与附录 E/F 用于上线约束与验收。
- **交易执行/工程**：先读 `2/3/8/9/11`，再以附录 A/B/C/D 作为实现与验收的“唯一口径”。
- **风控/管理**：先读 `1/2/6/9/10/13`，把“不交易/降档/熔断”当作系统主路径，而不是例外。

### 一页总览（系统只做这一条流水线）
1. **数据与执行健康**（附录 A）→ 计算 `data_health/exec_health`
2. **品种状态机**（附录 B）→ 得到 `symbol_state = NORMAL/DEGRADED/HALT`
3. **Regime**（第 4 章）→ 得到 `Regime = trend/range/transition`（可加 `vol_state`）
4. **模块产出 intent**（附录 D）→ 每个模块输出“意图单”，而不是直接下单
5. **风控裁决**（第 6 章 + 组合约束）→ 统一算仓位/杠杆/上限，超限则拒绝或缩量
6. **执行落单**（第 8 章）→ 订单状态机 + 保护 + 撤单/重试
7. **日志与复盘**（第 11 章）→ 交易可复现、可归因、可统计，驱动第 10 章失效检测

### 默认时间框架（你当前落地建议）
- `1H`：用于 `Regime/关键位/主趋势`（降低噪声、减少过拟合）
- `15m`：用于 `触发/定价/执行与保护`（更贴近成交与成本）

### “源头唯一”约定（避免实现分歧）
- 阈值/单位/方向/窗口：以附录 A（口径）与附录 C（参数模板）为准。
- 状态转移与冷却：以附录 B（状态机表）为准；正文只讲原则与业务含义。
- 策略模块接口：以附录 D（intent）为准；模块不得绕过风控与执行层直接下单。

# 实现规格（先读，作为唯一口径）

> 读法：量化/工程建议先把本节当作“接口与口径的定义”，再去读后续章节的业务含义与策略细节。

## 附录 A：统一口径（必须全局一致）

### A.1 价格与收益口径
- `mid = (best_bid + best_ask)/2`（若仅有 last/mark：不得用 last 代替 mid；缺 mid 时该品种 `HALT`）
- `price_exec`：成交价（来自回报）
- `price_mark`：标记价（用于强平/风控展示，不能用于回测撮合）
- `ret_t = ln(close_t / close_{t-1})`（默认对数收益；如用简单收益需全局一致）
- `range = high - low`
- `range_pct = range / close_{t-1}`（或 `/ close_t`，二选一并固定）

### A.2 成本与流动性口径
- `spread = (best_ask - best_bid) / mid`（单位：比例；展示可转成 %）
- `depth5`：`Σ_{k=1..5}(bid_qty_k*bid_px_k) + Σ_{k=1..5}(ask_qty_k*ask_px_k)`（单位：USDT 名义；若只统计单边必须改名为 `depth5_bid`/`depth5_ask`）
- `slippage = (price_exec - mid_at_send)/mid_at_send`（多头为正；空头可用绝对值或分方向统计，但口径固定）
- `dvol_tf`：周期 `tf` 的成交额（quote currency，推荐 USDT 口径）；若只提供 base 成交量则用 `dvol = vol_base * mid`
- `ADV_tf = MA(dvol_tf, n_adv)`：平均成交额（用于容量/参与率上限；窗口 `n_adv` 建议覆盖 ≥ 30 天）

### A.3 延迟与行情健康
- `ts_exch`：交易所事件时间戳（若无则用 server_receive_ts，不得混用）
- `ts_recv`：本地接收时间戳
- `ts_send`：本地下单发送时间戳
- `latency_md = ts_recv - ts_exch`（行情延迟，单位 ms）
- `mid_age = now - last_mid_update_ts`（中间价“年龄”，单位 ms）
- `clock_skew = now - ts_exch`（如可得；超阈值应 `HALT`）

### A.4 指标计算口径（示例）
- `ATR(14)`：同周期真波幅均值；单位与价格一致
- `bbw(20,2) = (upper - lower) / mid`（单位：比例）
- `dist(ema_a, ema_b) = |ema_a - ema_b| / ema_b`（单位：比例）
- `slope(x, n) = x_t - x_{t-n}`（或线性回归斜率；二选一并固定）

### A.5 合约规格（仓位计算必需）
每个交易品种必须提供（缺任何一个则禁止新开仓）：
- `contract_type ∈ {spot, perp_usdt, perp_coin}`
- `multiplier/face_value`（1 张合约代表的标的数量或名义）
- `min_qty`、`qty_step`、`tick_size`
- `max_leverage`、`maint_margin_schedule`（或可查询接口）
- `fee_taker`、`fee_maker`（如无法实时获取，需版本化配置）

---

## 附录 B：状态机转移表（Symbol State Machine）

> 原则：进入条件严格、退出条件更宽（hysteresis）+ 最短保持时间，避免抖动。

### B.1 状态与允许动作
| 状态 | 允许动作 | 强制约束 |
|---|---|---|
| `NORMAL` | 允许按模块开仓/加仓/减仓/平仓 | 仍需通过组合风控与 `NEWS_RISK` |
| `DEGRADED` | 允许减仓/平仓；允许**小仓**新开仓（仅模块 A 回调入场、模块 B 确认后入场） | 仓位系数 `<= 0.5`，禁止加仓，执行保护更严 |
| `HALT` | 只允许减仓/平仓 | 禁止任何新开仓；挂单全部撤销；进入冷却 |

### B.2 触发项定义（输入）
- `exec_health`：由 `spread/depth5/slippage/filled_ratio/reject_rate/latency_md/mid_age/connectivity` 计算的执行健康分
- `data_health`：由缺K、跳变、字段缺失、时钟漂移计算的数据健康分
- `NEWS_RISK ∈ {NORMAL, CAUTION, HALT}`：来自 4.3（计划内+计划外代理）

### B.3 转移规则（建议起点，可配置）
| 从 → 到 | 进入条件（满足任一） | 最短保持 | 退出条件（全部满足） | 冷却/恢复 |
|---|---|---:|---|---|
| `NORMAL → DEGRADED` | `spread >= spread_degrade_enter` 或 `depth5 <= depth5_degrade_enter` 或 `latency_md >= latency_degrade_enter` 或 `mid_age >= mid_age_degrade_enter` 或 `reject_rate >= reject_degrade_enter` | 60s | `spread <= spread_degrade_exit` 且 `depth5 >= depth5_degrade_exit` 且 `latency_md <= latency_degrade_exit` 且 `mid_age <= mid_age_degrade_exit` 且 `reject_rate <= reject_degrade_exit` 持续 60s | 无 |
| `DEGRADED → HALT` | `spread >= spread_halt_enter` 或 `depth5 <= depth5_halt_enter` 或 `latency_md >= latency_halt_enter` 或 `mid_age >= mid_age_halt_enter` 或 WS/REST 断连 `>= disconnect_halt_enter` 或关键字段缺失（A.1/A.2/A.5） | 300s | 所有 halt 触发项恢复到 exit 阈值并持续 300s | 进入 `cooldown_bars`（例如 3 根）期间禁止新开仓 |
| `NORMAL → HALT` | 直接满足任一 halt 进入条件 | 300s | 同上 | 同上 |
| 任意 → `HALT`（全局硬停） | 账户级熔断触发（6.3）或 `NEWS_RISK=HALT`（4.3.3） | 由熔断定义 | 按熔断恢复条件 | 恢复后 3 日保护（6.3） |

> 阈值命名约定：`*_enter` 用于进入更严格状态，`*_exit` 用于退出；必须满足 `enter` 更严格、`exit` 更宽（例如 `spread_degrade_enter=0.0008`，`spread_degrade_exit=0.0006`）。

---

## 附录 C：参数规格模板（每个参数必须这样写）

### C.1 参数条目模板
| 字段 | 含义 | 示例 |
|---|---|---|
| `name` | 参数名（全局唯一） | `spread_halt_enter` |
| `unit` | 单位（比例/%/USDT/ms/bar/倍数） | 比例 |
| `direction` | 触发方向（`>=` 或 `<=`） | `>=` |
| `window` | 统计窗口/持续时间 | `60s` |
| `source` | 数据源（L1/L2/K线/OI/资金费率） | L1 |
| `default` | 默认值 | `0.0010` |
| `adaptive` | 自适应方式（可选） | `max(default, P95(spread, 1w))` |
| `used_by` | 影响模块/状态机 | `B.3` |
| `rollback` | 回滚规则（上线后异常如何退回） | 回退到上个版本参数集 |

### C.2 建议的“尺度化”原则（避免跨币种失效）
- 位置/容差类：优先用 `ATR` 或分位数（如 `band = max(band_min, P50(range_pct, 252))`）
- 成本类：用 `spread/slippage` 分位数（如 P90/P95）并区分时段（UTC 白天/夜间）
- 成交量倍率：用 `vol / MA(vol,n)` 的分位数，而不是固定倍数

---

## 附录 D：模块 I/O 规格（Signal API）

> 目标：任何模块输出都统一成“意图单”（intent），再由风控与执行层裁决与落单。

### D.1 统一输入（所有模块都可用，缺失需显式禁用）
- 市场：`symbol`、`tf`、`OHLCV`、`ATR`、`ADX`、`BBW`、`EMA` 族
- 流动性：`mid`、`spread`、`depth5`、`mid_age`
- 执行：`latency_md`、`filled_ratio`、`reject_rate`
- 衍生品（可选）：`oi_change`、`funding`、`basis`
- 上下文：`Regime`、`NEWS_RISK`、`symbol_state`、`account_state`、`portfolio_exposure`

### D.2 统一输出（intent）
| 字段 | 含义 |
|---|---|
| `module` | `A/B/C` |
| `side` | `LONG/SHORT` |
| `setup_type` | `pullback / breakout_retest / false_breakout / event` |
| `entry_type` | `limit / market`（只是建议，执行层可改） |
| `entry_anchor` | `mid/level/ema_band` |
| `entry_price` | 计划价格（可空，表示由执行层定价） |
| `stop_price` | 必填（若无法定义则 intent 无效） |
| `tp_plan` | `R_targets` 或 `next_level_targets`（二选一，必须可计算） |
| `risk_mult` | 风险乘子（如 `0.5/1.0`，由模块建议） |
| `ttl` | 信号有效期（秒或 K 数） |
| `tags` | 关键标签：`regime=trend`、`news=caution`、`sweep=1` 等 |
| `required_fields` | 模块依赖字段列表（用于缺失时禁用） |

### D.3 模块 A（趋势）最低规格
- **启用前提**：`symbol_state != HALT`；`Regime ∈ {trend, transition}`；若 `NEWS_RISK=CAUTION` 则仅 `pullback` 且 `risk_mult<=0.5`
- **必需止损**：结构止损（摆动点/关键位）优先，否则 `1.5×ATR`；止损不可用则输出无效
- **失效/取消**：`ttl` 到期未成交；反向 sweep 未确认；进入 `DEGRADED/HALT`
- **输出差异**：`setup_type=pullback` 或 `breakout_retest`；`entry_anchor=ema_band/level`

### D.4 模块 B（均值回归/假突破）最低规格
- **启用前提**：`symbol_state != HALT`；`Regime ∈ {range, transition}`；若趋势过滤触发则禁用
- **确认规则**：若 `NEWS_RISK=CAUTION` 必须有确认根/吞没（5.4.1）
- **必需止损**：关键位外侧 `band+sweep_margin`（5.5.3）或摆动点外侧；不可用则输出无效
- **失效/取消**：突破失败结构不成立（未回吐/未确认）；进入 `DEGRADED/HALT`

### D.5 模块 C（事件驱动）最低规格（若启用）
- **启用门槛**：必须满足 5.3 的执行门槛且 `NEWS_RISK!=HALT`
- **输出要求**：必须声明 `ttl` 很短（bar 级），并强制 `risk_mult<=0.5`（除非另有回测证据）
- **禁用优先**：任何执行健康恶化直接取消 intent（让状态机接管）

### D.6 日志验收（每笔 intent/订单都必须可复现）
- `intent_id`（幂等键）、`module/rule_id/tags`
- `config_version`、`git_hash`、`exchange`、`contract_spec_version`
- `symbol_state/account_state/NEWS_RISK/Regime` 快照
- `order_ids/fill_ids`、部分成交轨迹、撤单原因
- `spread/depth5/latency_md/mid_age/slippage` 快照（至少下单时与成交时）
- `dvol_15m/dvol_1H`、`dvol_norm`、`VOL_STATE_15m/VOL_STATE_1H`（至少信号触发与成交时）

---

## 1. 第一性原理：交易系统的三件事

### 本章与第一性原理的对应
任何自动化交易系统最终只需要回答三问：**目标函数是什么**（怎么定义“好”）、**优势是否真实存在**（是否可检验）、**约束是否硬性生效**（何时必须停）。本章把这些作为不变量，后续所有章节都是对它们的工程化展开。

### 1.1 系统目标（可度量）
- **生存优先**：长期不爆仓、不出现不可恢复回撤；以最大回撤（MDD）和回撤恢复时间为硬约束。
- **稳定复制**：同一套规则在不同市场阶段仍可运行；以“策略失效检测”和“降档/停机机制”保证可控。
- **可执行可审计**：每一笔交易都能回溯到规则编号、当时的市场状态、风控约束和执行质量评分。

### 1.2 边际优势来源（必须可检验）
本系统只承认三类可检验的优势来源：
1. **趋势持续性（Trend Persistence）**：在特定波动与流动性条件下，价格的方向性延续概率 > 随机。
2. **均值回归（Mean Reversion）**：在“冲动扩张 + 失败确认”的结构中，回归到均值的期望收益为正。
3. **微观结构/事件冲击（Microstructure / Event）**：点差、深度、延迟与订单簿变化导致短期定价偏离，且可通过执行规则捕捉。

> 任何规则如果不能归因到上述之一，并且无法用回测/实盘统计证明，就应当视为“装饰性规则”，默认不进入实盘。

### 1.3 不变量（任何时候都不能破）
- 单笔最大风险 `RISK_TRADE_MAX = 2%`（净值口径）。
- 总回撤硬熔断 `DD_HARD = 25%`（清仓 + 停机 + 冷却期）。
- 数据不合规/执行不可控时 **宁可错过，不可硬做**（由状态机强制）。

---

## 2. 系统边界与状态机（把“不能交易”写清楚）

### 本章与第一性原理的对应
自动化系统的第一性原理是：**在信息不可靠或执行不可控时，期望收益不可计算**，此时最优动作是“不交易”。因此必须先有状态机来定义“可交易/降档/停止”，并把它放在所有策略之上，作为生存约束。

### 2.1 系统边界
- 本文描述：**信号 → 下单 → 风控 → 复盘** 的规则，不讨论数据采集/撮合实现细节。
- 交易对象默认：**高流动主流币**（BTC/ETH 等），USDT 本位永续为主；现货可复用，但需重新校准费率与滑点。

### 2.2 品种状态机
系统对每个品种维护状态：`NORMAL / DEGRADED / HALT`
- `NORMAL`：允许按策略模块正常交易。
- `DEGRADED`：允许交易，但强制降档（仓位/杠杆/频率下降）。
- `HALT`：禁止新开仓，仅允许减仓/平仓。

**门槛与转移表（实现唯一口径）**：见附录 B。正文只保留解释：`spread/depth5/latency_md/mid_age` 等指标本质上刻画“是否可定价、是否可成交”；不可控时进入 `DEGRADED/HALT`，强制把“错过机会”优先于“承担不可定价风险”。

#### 2.2.1 滞回与冷却（自动化必需，避免抖动/过度交易）
第一性原理：状态机是“执行可控性”的硬约束，而执行指标天然噪声大。没有滞回与冷却，系统会在边界来回切换，导致追涨杀跌与频繁撤单。

定义：
- `cooldown`：进入 `DEGRADED/HALT` 后的最短冷却时间（禁止从更保守状态立刻恢复）
- `recover_window`：恢复观察窗口（在窗口内持续满足恢复条件才允许恢复）

建议默认值（可配置）：
- 以附录 B 为准（进入/退出阈值 + 最短保持 + 冷却）。正文不再重复具体数值，避免“口径漂移”。

恢复条件（必须在 `recover_window` 内持续满足）：
- 以附录 B 的 `*_exit` 阈值为准（例如 `latency_md`、`spread`、`depth5`、`mid_age` 等同时恢复并持续一段时间）。

升级规则（无需滞回，立即生效）：
- 任意时刻触发停止门槛 → 立即 `HALT`
- `NEWS_RISK = HALT` → 该品种视为 `HALT`（仅影响“新开仓权限”，不改变状态机指标记录）

降档动作（与后文一致）：
- `DEGRADED`：仓位系数 `<= 0.5`、禁止加仓、仅允许模块 A 的回调入场与模块 B 的确认后入场
- `HALT`：禁止新开仓，仅允许风控出场

---

## 3. 数据口径与指标（统一定义，避免误用）

### 本章与第一性原理的对应
规则要可检验，首先要让“测量”稳定：同一件事在系统里只能有一种定义。数据口径与指标样本的统一，是把优势来源从“主观描述”变为“可统计事实”的前提；数据质量硬过滤则是在保护统计结论不被脏数据破坏。

### 3.1 基础口径
- 时区：默认 `UTC`；日线收盘 `00:00 UTC`。
- K 线默认频率：未注明则为 `1H`。
- 公平价（mid）：`mid = (bid1 + ask1) / 2`。
- 成交量/成交额（强烈建议统一为“报价货币成交额”）：见 3.1.1 与附录 A；本文后续涉及成交量阈值时，默认使用 `dvol`（成交额，quote currency，USDT 口径）。

### 3.1.1 派生量（文中默认用法，避免实现歧义）
- 布林带宽 `bbw(20,2) = (upper - lower) / middle`（同周期）
- 均线距离 `dist(a,b) = |a - b| / b`
- 斜率 `slope(x, n) = (x_t - x_{t-n}) / x_{t-n}`（可按需要改为回归斜率）
- 影线比例 `wick_ratio = (upper_wick + lower_wick) / max(body, ε)`
- 分位数阈值 `Pq(x, q, n)`：在滚动窗口 `n` 内取分位数 `q`（用于波动/成交量/成本的自适应阈值）
- 成交额 `dvol = vol_base * mid`（若交易所直接提供 quote 成交额，则优先使用 quote 成交额，避免乘 mid 引入噪声）
- 成交量归一 `dvol_norm = dvol / MA(dvol, n)`（用于“放量/缩量”跨时段可比）
- 成交量 Z 分数 `dvol_z = (dvol - MA(dvol, n)) / STDEV(dvol, n)`（可选，用于事件/冲击识别）

### 3.1.2 数据缺失与降级策略（自动化必需）
第一性原理：当关键数据缺失时，系统对“优势是否存在”的判断会退化；默认应转向保守（少交易或不交易），而不是“照常运行”。

按数据源分级（从强到弱）：
1. L2/L1 盘口（`bid/ask/depth5`）与延迟指标（执行可控性）
2. K 线（OHLCV）
3. OI / funding / basis（拥挤度代理，可选）
4. 经济日历/事件标签（计划内事件，可选）

缺失动作（建议默认）：
- 缺 `bid/ask` 或 `mid_age` 不可信 → 该品种直接 `HALT`（无法定价/无法下单）
- 缺 K 线或 K 线缺口频繁 → 禁止依赖形态/Regime 的模块（A/B），仅允许风控出场
- 缺 OI/funding/basis → 相关规则（5.6.3、3.3.2）自动失效，不参与决策（不得用“0”代替）
- 缺经济日历 → `NEWS_RISK` 仅使用 `4.3.2` 的市场变量代理；同时把 `NEWS_RISK` 的阈值下调一档（更容易进入 `CAUTION`）

实现要求（防止“静默错误”）：
- 每条规则声明所需字段集；字段不全时该规则必须显式 `DISABLED` 并写入日志/指标
- 任何缺失导致的降级都要可观测（日志字段中记录 `data_health` 与禁用的规则集）

### 3.2 数据质量（硬过滤）
任一触发则**当根信号作废**：
- 连续缺失 ≥ 1 根 K：视为缺口，不插值，不跨缺口判断形态/背离。
- 单根跳幅 `> 10%` 且成交量异常：不直接判定“数据无效”，而是进入 **异常分类与动作**（见下）。
- 入场信号出现后 `3 根 K` 内未成交（限价）→ 信号过期。

### 3.3 成交量异常：分类优先于过滤（自动化必备）
成交量“异常”可能来自两类完全不同的机制：
- **数据/撮合异常**（脏数据、分段成交回补、交易所统计口径跳变、插针伴随的异常成交）
- **真实信息冲击**（宏观/公告/清算瀑布/流动性瞬间枯竭导致的放量）

第一性原理：如果无法区分二者，就无法给“优势是否存在”定价；最佳默认动作不是“继续交易”，而是用状态机把系统移出不确定区域。

#### 3.3.1 异常定义（以滚动均值为基线）
- `vol_ma = MA(vol, 20)`（同周期）
- 放量：`vol > 3×vol_ma`
- 极端缩量：`vol < 0.2×vol_ma`

#### 3.3.2 异常分类（建议的最小特征集）
对“放量 + 大波动”的 K 线，计算以下特征（同周期或更高频可替换）：
- `spread`、`depth5`、`latency_md`、`mid_age`：执行可控性
- `return_abs`：当根绝对涨跌幅
- `range_pct`：当根振幅
- `wick_ratio`：上下影线/实体占比（插针倾向）
- `follow_through`：后续 2 根的延续性（用可计算判据替代“快速回吐”，见下）
- `oi_change`（如可得）：未平仓量变化（清算/加仓/挤兑）
- `funding`/`basis`（如可得）：资金费率与基差跳变（拥挤度/杠杆偏向）

#### 3.3.3 动作映射（把“不确定”转成确定行为）
- 若同时满足任一执行风险：`spread`/`depth5`/`latency_md`/`mid_age` 触发降档/停止门槛 → 直接交给状态机（`DEGRADED/HALT`），并对该品种启动 `cooldown`。
- 若执行风险未触发，但出现“插针 + 回吐”特征 → 当根及后续 `ban_bars=2` 根内禁用模块 A/B 的新开仓（只允许风控出场；`ban_bars` 可配置）。
- 若执行风险未触发，且出现持续性（`follow_through` 为真）→ 将该段标记为“事件冲击样本”，用于后续统计（模块 C 仍需满足其启用门槛）。

其中（以 1H 为例，同周期计算）：
- 插针：`wick_ratio >= 2.0` 且 `body_pct <= 0.35`
- 回吐：对“向上突破”场景，`close_t < level - band` 或 `close_{t+1} < level - band`（向下突破对称）
- 延续：`close_{t+2}` 仍在突破方向的 `level + band` 之外，且 `ADX` 上升或 `dist(ema144, ema576)` 扩大（满足其一）

### 3.4 指标与最小样本（建议）
| 指标 | 参数 | 最小样本（建议） |
|---|---|---|
| EMA | 12/144/169/576/676 | `>= 3×最大周期` |
| Bollinger | (20,2) | `>= 100` |
| ADX | 14 | `>= 100` |
| ATR | 14 | `>= 100` |
| RSI | 14 | `>= 100` |
| MACD | (12,26,9) | `>= 200` |

---

## 4. 市场状态识别（Regime）：先决定“做什么”，再谈“怎么做”

### 本章与第一性原理的对应
边际优势并非在所有时间都存在。第一性原理是把市场看成不同的“生成机制”（趋势/震荡/过渡），并让策略只在其优势成立的机制下启用；否则同一套规则会在错误的 Regime 中系统性亏损。

### 4.1 技术面 Regime：趋势 / 震荡 / 过渡
#### 震荡市判定（全部满足）
1. `ADX(14) < 20`
2. 布林带宽 `bbw(20,2) < 4%`
3. `ema144/ema169/ema576` 两两距离 `< 1%`（缠绕）
4. 近 20 根 K 振幅 `< 8%`

#### 趋势市判定（满足任一，且不处于震荡）
- `ADX(14) > 25`，且 `dist(ema144, ema576) > 2%`
- 或：`dist(ema144, ema576) > 3%` 且 `|slope(ema576, 20)| > 0`（避免“距离很大但已走平”的末期假趋势）

#### 过渡区处理
- 若 `ADX 20~25` 或均线距离 `1%~2%` → 过渡区：**跟随更高周期方向**，并将仓位系数限制在 `<= 0.5`。

### 4.2 宏观 Regime（可选：默认自动判定）
原文“四年周期/牛熊”属于宏观假设，但如果用于自动化系统，必须改成可计算的状态变量。宏观 Regime 只用于限制杠杆与仓位上限，不直接生成信号。

建议默认定义（以日线为准）：
- `BULL`：`close_1D > ema576_1D` 且 `slope(ema576_1D, 20) > 0`
- `BEAR`：`close_1D < ema576_1D` 且 `slope(ema576_1D, 20) < 0`
- `NEUTRAL`：其余情况

> 宏观 Regime 可在实现中通过开关禁用；禁用时仅使用技术面 Regime（趋势/震荡/过渡）与状态机约束。

### 4.3 宏观/消息面风险状态（自动化：把“未来不确定”变成可执行约束）
你提出的“任何开/平仓都考虑宏观与消息面未来表现”，在自动化里必须落到一个可计算的风险状态 `NEWS_RISK = NORMAL / CAUTION / HALT`，并强制影响仓位、杠杆与是否允许开仓。

#### 4.3.1 计划内事件（Scheduled）
- 输入：经济日历/政策会议/重大数据发布时间戳（建议用配置文件或服务提供；系统只消费“时间+影响等级”）
- 规则：在事件窗口内强制降档/停机
  - `CAUTION`：事件前后 `T=60min`（可按品种/级别调参）
  - `HALT`：事件前后 `T=15min`，或窗口内 `spread/depth5/latency_md` 触发降档门槛

#### 4.3.2 计划外消息冲击（Unscheduled：用市场变量做代理）
满足任一则提升风险状态（按强度）：
- 执行层冲击：`spread` 突然扩张、`depth5` 突然坍塌、`latency_md` 抬升（直接走状态机）
- 波动冲击：1min 或 5min 实现波动率/振幅跳变（阈值用分位数 P90/P95）
- 拥挤度冲击（如可得）：`funding`/`basis` 跳变、`oi_change` 激增且伴随“回吐”（判据见 3.3.3/5.6.3）
- 量价冲击：触发 `3.3` 的成交量异常分类，且属于“事件冲击样本”

#### 4.3.3 动作（必须全局生效）
- `NEWS_RISK = CAUTION`：禁止加仓；新开仓仓位系数 `<= 0.5`；止损/止盈更保守（见第 7 章）
- `NEWS_RISK = HALT`：禁止新开仓，仅允许风控出场

### 4.4 成交量/流动性状态（Volume State，15m/1H 强烈建议启用）
第一性原理：很多“信号失效”并不是方向错，而是**容量与成本**变了。成交量（更准确是成交额 `dvol`）是最直接的“可交易性代理”：它决定了你能用多大仓位、能不能用市价、以及突破/假突破信号的可信度。

定义（推荐最小实现，按 `15m` 与 `1H` 分别计算）：
- `dvol_tf`：该周期成交额（3.1.1）
- `q_low_tf = Pq(dvol_tf, q=0.20, n)`、`q_high_tf = Pq(dvol_tf, q=0.80, n)`（窗口 `n` 建议覆盖 ≥ 30 天）
- `VOL_STATE_tf`：
  - `LOW`：`dvol_tf <= q_low_tf`
  - `HIGH`：`dvol_tf >= q_high_tf`
  - `NORMAL`：其余

动作映射（全局生效，优先级低于 `HALT` 但高于策略模块）：
- `VOL_STATE_15m = LOW`：禁止追突破（模块 A 的 `breakout_retest` 禁用）；市价单禁用；新开仓 `risk_mult <= 0.5`
- `VOL_STATE_1H = LOW`：整体降频（仅允许“回调入场/确认后入场”）；组合总名义上限乘以 `0.7`
- `VOL_STATE_15m = HIGH`：允许事件样本标记与更积极的止盈分批，但执行保护更严（滑点/成交率门槛不放宽）

> 备注：若要处理强季节性（UTC 时段差异），可把 `Pq` 改为“按小时分桶”的分位数；先用全局分位数做 MVP，跑稳后再分桶。

---

## 5. 策略模块（每个模块都必须有：前提 → 触发 → 失效 → 风控）

### 本章与第一性原理的对应
策略不是“多写几个信号更赚钱”，而是把优势来源模块化：每个模块只服务一种可检验优势，并声明其成立前提与失效条件。这样系统才能在统计上定位：到底是优势消失、执行变差，还是风险约束没生效。

### 5.1 模块 A：趋势捕获（多周期共振 + 均线结构）
**优势归因**：趋势持续性。  
**适用前提**：技术面 Regime = 趋势或过渡（非明确震荡）；品种状态 != `HALT`。

#### A1. 多周期共振（方向裁决）
周期：`1D` 定方向，`4H` 定入场区域，`1H` 精确入场。

| 1D | 4H | 1H 信号 | 动作 | 仓位系数 |
|---|---|---|---|---|
| 同向 | 同向 | 同向 | 顺势开仓 | 1.0 |
| 冲突 | 与 1D 冲突 | 与 1D 同向 | 顺势小仓 | 0.5 |
| 任意 | 任意 | 与 1D 反向 | 不开仓 | - |

#### A2. 结构定义（多/空排列）
- 多头排列：`ema144 > ema169 > ema576`
- 空头排列：`ema144 < ema169 < ema576`
- 趋势失效：任一关键均线穿越或距离回落到 `< 1%`（缠绕）→ 模块 A 降档或停用。

#### A3. 入场触发（最小必要集合：两类就够）
第一性原理：趋势优势来自“延续”，入场必须发生在 **风险可定义** 的位置（可明确止损与 R），不得用“追价”替代结构入场。

全局约束（每次开仓必须先过）：
- `NEWS_RISK = HALT` → 禁止新开仓
- `NEWS_RISK = CAUTION` → 禁止追突破，只允许“回调入场”，且仓位系数 `<= 0.5`
- `VOL_STATE_15m = LOW` → 禁止追突破（本模块的“突破-回踩入场”禁用），且市价单禁用；仓位系数 `<= 0.5`
- 触发反向 `Liquidity Sweep`（5.6.1）→ 必须等待 1 根确认，否则取消信号

1) 回调入场（顺势）
- 多头：价格回调进入 `ema144~ema169` 区间，且 1H 收盘重新站回 `ema144`（或出现向上吞没/破前高确认）
- 空头：价格反弹进入 `ema144~ema169` 区间，且 1H 收盘重新跌破 `ema144`（或出现向下吞没/破前低确认）
- 订单：优先限价（`mid ± 0.05%`），未成交按统一撤单/过期处理
- 止损：优先结构止损（最近摆动点 ± 缓冲），无结构则用 `1.5×ATR(14)`

2) 突破-回踩入场（顺势）
- 多头（全部满足）：
  1. 突破：`close_t > level + band`（`level` 来自 5.5 的关键阻力位或近 20 根最高）
  2. 不回吐：`close_{t+1} >= level - band`
  3. 回踩不破：`low_{t+1} >= level - band`
  4. 再确认：`close_{t+2} > max(high_t, level + band)` 或出现 `5.4.1` 看涨吞没
  5. 成交量门槛（建议参数化，避免低流动性假突破）：突破根或确认根满足 `dvol_norm >= 1.0`（或 `dvol >= Pq(dvol, 0.50, n)`）
- 空头（全部满足）：
  1. 跌破：`close_t < level - band`（`level` 来自 5.5 的关键支撑位或近 20 根最低）
  2. 不回抽：`close_{t+1} <= level + band`
  3. 回抽不破：`high_{t+1} <= level + band`
  4. 再确认：`close_{t+2} < min(low_t, level - band)` 或出现 `5.4.1` 看跌吞没
  5. 成交量门槛（同上）：突破根或确认根满足 `dvol_norm >= 1.0`（或 `dvol >= Pq(dvol, 0.50, n)`）
- 过滤：触发 `3.3` 的异常分类时，默认禁开仓/降档（该窗口内不允许突破追价入场）

### 5.2 模块 B：均值回归（假突破）
**优势归因**：失败结构后的回归。  
**适用前提**：技术面 Regime = 震荡或过渡；品种状态 != `HALT`。

全局约束（每次开仓必须先过）：
- `NEWS_RISK = HALT` → 禁止新开仓
- `NEWS_RISK = CAUTION` → 只允许“确认后入场”（B1 的第 5 条），且仓位系数 `<= 0.5`
- `VOL_STATE_15m = LOW` → 只允许更严格确认（吞没或 2 根同向确认），且仓位系数 `<= 0.5`；市价单禁用
- 触发 `Liquidity Sweep`（5.6.1）但未出现确认 → 禁止逆势抄底/摸顶

#### B1. 假突破定义（以 20 根区间为参考）
第一性原理：假突破本质上是一次“扫流动性 → 失败回收”的结构，因此必须和关键位（5.5）绑定，否则只是随机噪声。

看涨假突破（用于做空，全部满足）：
1. 在关键阻力位附近发生：`high` 突破关键位（或近 20 根最高）且幅度 `>= sweep_margin`
2. `close` 回落到关键位下方 `>= 0.1%`（失败回收）
3. 上影线 `>= 实体×1.5`
4. 成交量 `> 前 3 根均量×1.2`
5. 需 1 根确认：确认根收盘与预期方向一致（可用 5.4 吞没替代）
6. 成交量结构（建议，用于减少噪声）：突破根 `dvol_norm` 上升且确认根 `dvol_norm` 回落（“冲动后衰竭”）；不满足则将 `risk_mult` 下调一档（例如 `1.0 → 0.5`）

看跌假突破（用于做多）对称定义。

#### B2. 防呆与过滤
- 最小实体：实体/振幅 `>= 30%` 且振幅 `>= 1%`
- 成交量异常处理：不做“一刀切过滤”，改为使用 `3.3` 的异常分类与动作；默认策略是“异常期禁开仓/降档”，而不是把样本直接丢弃。
- 趋势过滤：若 `|ema144 - ema576| / ema576 > 5%`，则逆势回归信号一律忽略。

### 5.3 模块 C：事件驱动（可选，默认关闭）
**优势归因**：事件冲击下的微观结构失衡。  
**原则**：事件期最大风险来自“点差扩张 + 滑点失控 + 断连”，因此模块 C 必须在 `NORMAL` 且执行质量稳定时才启用。

启用门槛（任一不满足则禁用模块 C）：
- 品种状态 = `NORMAL`
- `spread <= 0.08%`
- `depth5 >= 100,000 USDT`
- `latency_md <= 200ms`

执行约束（启用后强制）：
- 杠杆上限 `<= 2.5×`
- 仓位上限（名义）`<= 30% NAV`
- 禁止加仓、禁止摊薄、事件后 `3 根 K` 未达目标1即时间止损

### 5.4 价格行为信号库（吞没/大阳线等：只做“确认与定位”）
第一性原理：K 线形态本身不是优势来源，它只是“订单流/流动性行为”的可见投影。形态信号只允许用于：
- **确认**：在模块 A/B 已满足前提时，提高信号质量
- **定位**：把入场/止损/止盈锚定到可解释的位置（结构位、流动性位）

统一量化（同周期）：
- `body = |close - open|`，`range = high - low`
- `body_pct = body / max(range, ε)`
- `close_pos = (close - low) / max(range, ε)`（0=收在最低，1=收在最高）
- “大 K”：`range >= 1.5×ATR(14)` 或 `range_pct` 进入近 252 根的 P90

#### 5.4.1 吞没形态（Engulfing）
**看涨吞没（用于做多确认）**（全部满足）：
1. 前一根为阴线（`close_prev < open_prev`），当前为阳线（`close > open`）
2. 当前实体覆盖前一实体：`open <= close_prev` 且 `close >= open_prev`
3. `body_pct >= 0.6` 且 `close_pos >= 0.7`
4. 发生位置满足其一：靠近支撑位（见 5.5）/均线回调带（模块 A）/假突破回收（模块 B）

**看跌吞没**对称定义。

用法：
- 模块 A：回调入场时作为“确认”信号（替代自然语言的“重新转强/转弱”）
- 模块 B：假突破后的确认根，可用吞没替代“确认根同向收盘”

#### 5.4.2 大阳线/大阴线（Impulse Candle）
**大阳线（用于趋势延续或突破确认）**（全部满足）：
1. `close > open`
2. `body_pct >= 0.7` 且 `close_pos >= 0.8`
3. `range` 为“大 K”
4. 位置约束：突破关键阻力位后（见 5.5）满足“不回吐”判据：`close_{t+1} >= level - band`

**大阴线**对称定义。

用法：
- 只允许在 `NEWS_RISK != HALT` 且未触发 `3.3` 的“执行不可控”场景下使用；否则一律视为“不可定价冲击”，禁止追价。

#### 5.4.3 插针/流动性扫损（Pin / Sweep Candle）
用于刻画你说的“庄家动作”的最小可观测代理（不假设动机，只识别行为）：
- 插针特征：`wick_ratio >= 2.0` 且 `body_pct <= 0.35`，并且突破关键位后满足“回吐”判据（见 3.3.3）
- 动作：作为 `Liquidity Sweep` 触发源（见 5.6.1），并触发 `3.3` 的异常动作映射；对新开仓实施“等待确认/取消信号”的硬约束（见 A3/B2）。

### 5.5 支撑/阻力与关键位（自动化：用“结构位/流动性位”统一）
第一性原理：支撑/阻力不是线，而是**流动性聚集区**（止损/止盈/挂单密集处）。系统要做的是识别这些“区”，并用它们来约束开仓位置与出场锚点。

#### 5.5.1 关键位来源（建议最小集合）
- 结构高低点（Swing）：近 `L=2~3` 的分形高/低点（pivot）
- 近 `N=20/50` 根的区间高/低（与模块 A/B 的突破/假突破一致）
- 前日高/低（PDH/PDL）、前周高/低（PWH/PWL）
- 均线带：`ema144~ema169`（趋势回调带）

#### 5.5.2 关键位“强度”与容差
- 强度：触碰次数、反应幅度、最近性（可做指数衰减）
- 容差（把线变成区）：`band = max(0.2%, 0.3×ATR(14)/price)`
- “靠近”定义：`|price - level| / level <= band`

#### 5.5.3 用法（必须落到开/平仓）
- 开仓（硬条件）：
  - 模块 B（均值回归/假突破）：必须满足“靠近关键位”：`|entry - level| / level <= band`，且出现 `5.4` 的确认（吞没或确认根同向收盘）。
  - 模块 A（趋势/回调）：允许以均线带作为结构锚（`ema144~ema169`），但若同时存在关键位 `level`，则要求 `|entry - level| / level <= 3×band`（禁止在流动性区外追价）。
- 止损（硬规则，统一“扫损偏移”）：
  - 以关键位止损：`stop = level - (band + sweep_margin)`（多头；空头对称为 `level + (band + sweep_margin)`）
  - 以摆动点止损：`stop = swing_low - sweep_margin`（多头；空头对称）
  - 若 `stop` 距离“关键位/整数价聚集点”过近（`|stop - cluster_price| <= 2*tick`），则再向不利方向偏移 `2*tick`（防止止损落在聚集点）
- 止盈（硬规则，关键位优先于 R）：
  - 设 `next_level` 为入场方向上的最近关键位；若其距离对应的 `R` 小于目标 `R`，则目标以 `next_level` 为锚点（先落袋）。
  - 若不存在可用 `next_level`，才使用第 7 章的 `R` 目标。

### 5.6 庄家/大单行为（自动化可用的“行为代理”）
第一性原理：无法直接观察“庄家意图”，只能观察其在价格与流动性上的痕迹。把“庄家行动”落地为可计算的三个代理，并强制参与每次开/平仓裁决。

#### 5.6.1 代理 1：扫流动性（Liquidity Sweep）
触发（示例，全部满足）：
1. 价格越过关键位 `level` 的幅度 `>= sweep_margin`
2. 同根收盘回到关键位内（突破失败）
3. `wick_ratio` 高或 `range` 为“大 K”

动作：
- 若 sweep 方向与拟开仓方向相反：新开仓强制等待 1 根确认（可用 5.4 吞没/冲动 K），否则取消信号
- 若持仓中遇到反向 sweep：立即降风险（减仓/收紧止损到结构内侧），并禁止加仓

#### 5.6.2 代理 2：吸收/派发（Absorption/Distribution，弱代理）
若可获取盘口/逐笔，可用更精确指标；在仅有 K 线时用弱代理：
- 放量但价格推进失败：`vol > 3×vol_ma` 且 `body_pct <= 0.35` 且 `wick_ratio >= 2.0`
- 动作：将其视为“关键位强度 +1”的证据（见 5.5.2 的强度模型），并将持仓管理切到“保守档”：分批阈值向前移动 `0.5R`，ATR 跟踪系数下调一档（例如 `1.0 → 0.8`）

#### 5.6.3 代理 3：拥挤度与清算压力（Crowding / Liquidation Proxy）
若可得 `oi_change`、`funding`/`basis`：
- `oi_change` 激增 + 价格快速回吐：视为“拥挤+清算风险上升”
- 动作：对新开仓降档（仓位系数 `<= 0.5`）；对持仓切换保守参数（见 7.3 的 `tp_mult` 与 ATR 跟踪提前），并将保本移动阈值从 `>=1R` 提前到 `>=0.5R`

其中（建议的最小可计算判据，阈值可用分位数自适应）：
- `oi_change >= Pq(oi_change, 0.95, 252)`，且出现“回吐”：`close_{t+1}` 回到关键位区间内（见 3.3.3）
- `funding` 或 `basis` 的绝对值进入近 252 根的 P95，且与价格方向同向（拥挤）

> 上述代理不要求“解释动机”，只要求把可观测行为映射为可执行动作，从而在任何开/平仓点都“考虑庄家行动”。

---

## 6. 统一风控：仓位、杠杆、熔断（从“能不能活”倒推）

### 本章与第一性原理的对应
交易系统的根本矛盾是：优势微弱且会波动，但亏损可以非线性扩大（杠杆、跳空、相关性）。因此第一性原理是先固定“最大可承受损失”，再让策略在这个约束内优化收益。风控不是策略的一部分，而是策略的可行域。

### 6.1 单笔风险档位
| 账户状态 | 单笔风险上限 | 动作 |
|---|---:|---|
| 正常 | 2.0% | - |
| 连亏 2 次 | 1.0% | 风险降档 |
| 连亏 4 次 | 0.5% | 保护模式 |
| 连亏 6 次 | 0% | 停止新开仓 24h |

全局夹紧（与 4.3 对齐）：
- `NEWS_RISK = CAUTION`：单笔风险上限再乘以 `0.5`（等价于“只做小仓、禁加仓”）
- `NEWS_RISK = HALT`：单笔风险上限视为 `0%`（禁止新开仓）

### 6.2 风险一致的仓位计算（USDT 本位永续口径）
定义：
- `E`：净值（USDT）
- `r`：单笔风险比例（如 0.02）
- `entry`：计划入场价
- `stop`：止损价
- `fee`：双边手续费率（如 0.0004）
- `slip`：滑点保护（如 0.001）

计算：
```
止损距离 d = |entry - stop| + entry*slip + entry*fee*2
数量 qty = (E * r) / d
名义价值 notional = qty * entry
```
约束（取最小值）：
- `notional <= E * NOTIONAL_CAP_PCT`（例如 70%）
- `notional <= E * leverage_limit`（平台与宏观/品种状态共同限制）
- **容量/成交额约束（强烈建议，解决“量不够导致滑点失控”）**：
  - 定义 `ADV_1H = MA(dvol_1H, n_adv)`（建议 `n_adv` 覆盖 ≥ 30 天）
  - 设参与率 `p`（可按 `entry_type` 区分，限价更高、市价更低）
  - 增加约束：`notional <= p * ADV_1H`
  - 若 `VOL_STATE_15m = LOW` 或 `symbol_state = DEGRADED`：将 `p` 再乘以 `0.5`（等价于“同样信号更小仓”）

> 这样可保证：无论品种价格高低、杠杆大小，止损打到时理论亏损不超过 `E*r`（忽略极端跳空）。

### 6.3 账户级熔断（统一口径）
| 级别 | 触发条件 | 处理措施 | 恢复条件 |
|---|---|---|---|
| 一级预警 | 日亏损 `>= 3%` | 仓位上限减半，风险档位下降一级 | 回撤 `< 1.5%` 且连续 3 日净值为正 |
| 二级预警 | 周亏损 `>= 8%` | 停止新开仓，仅允许减仓 | 回撤 `< 4%` 且连续 3 日净值为正 |
| 三级熔断 | 月亏损 `>= 15%` | 停止交易 + 生成复盘报告（自动） | 回撤 `< 7.5%` 且连续 3 日净值为正 |
| 绝对熔断 | 总回撤 `>= 25%` | 清仓 + 停机 + 冷却 7 日 | 冷却期结束 + 自动复盘任务完成 + 连续 3 日净值为正 + 健康指标达标 |

恢复后 3 日保护：仓位上限减半、风险档位不超过 1%、禁止加仓。

### 6.4 组合风控（Portfolio Guardrail，自动化必需）
第一性原理：单策略/单品种风控只能控制“单点风险”，无法控制“相关性叠加风险”。组合风控的目标是：在任何时刻把系统暴露限制在可承受范围内，并在市场共振时自动收缩。

定义（以净值 `E` 为基准，按品种 `i`）：
- 名义敞口：`notional_i = qty_i * entry_i`
- 方向：`dir_i ∈ {+1,-1}`
- 单品种净敞口：`net_i = dir_i * notional_i`
- 总名义敞口：`gross = Σ |notional_i|`
- 总净敞口：`net = |Σ net_i|`

硬约束（建议起点，可配置）：
- `gross <= 2.0 * E`（总杠杆/总名义上限）
- `net <= 1.0 * E`（方向性净敞口上限）
- 单品种：`|notional_i| <= 0.7 * E`（与 6.2 的 `NOTIONAL_CAP_PCT` 对齐）
- 单交易所：同一交易所的 `gross_exch <= 1.5 * E`（防单点故障）

相关性约束（滚动相关系数，建议用 1H 收益）：
- 计算 `corr(i,j) = corr(ret_i, ret_j)`，窗口 `n=168`（一周）
- 若 `corr(i,j) >= 0.7` 且 `dir_i = dir_j`，视为同一“风险簇”
- 对每个风险簇 `g`：`gross_g <= 1.0 * E`，超出则按比例缩放新开仓仓位（或直接拒单）

保证金/强平缓冲（平台约束必须先过）：
- 维护 `margin_ratio` 与阶梯保证金占用；若 `margin_ratio` 进入危险区（例如 `< 1.5`）→ 禁止新开仓并降杠杆
- 对冲不等于无风险：若同簇内对冲导致 `gross` 上升但 `net` 下降，仍需满足 `gross` 上限

与 `NEWS_RISK`/状态机联动：
- `NEWS_RISK = CAUTION`：将 `gross` 与 `gross_g` 上限再乘以 `0.7`
- 任一品种 `HALT` 不强制平仓，但禁止同向加仓，避免在执行不可控时扩大组合风险

---

## 7. 统一出场：止损、止盈、时间止损（让盈亏分布可控）

### 本章与第一性原理的对应
入场只决定“方向与位置”，出场决定“盈亏分布”。第一性原理是把不确定性压缩到可控范围：止损限制左尾风险、分批与跟踪让右尾收益保留、时间止损避免在优势不成立时占用风险预算。

### 7.1 止损优先级
| 类型 | 计算方式 | 适用场景 | 优先级 |
|---|---|---|---:|
| 结构止损 | 前一波段高/低点 ± 0.3% | 关键位置入场 | 1 |
| ATR 止损 | 入场价 ± `1.5×ATR(14)` | 趋势行情 | 2 |
| 固定比例 | 入场价 ± 2% | 事件窗口 | 3 |

### 7.2 R 定义与移动止损
- `R = |entry - stop_initial|`（初始风险单位）

| 盈利阶段 | 止损调整 |
|---:|---|
| `>= 1R` | 移至保本位（含手续费缓冲） |
| `>= 1.5R` | 移至 `+0.5R` |
| `>= 2R` | `ATR(14)×1.0` 跟踪 |
| `>= 3R` | `ATR(14)×0.8` 跟踪（收紧） |

### 7.3 止盈与分批
| 市场状态 | 目标1 | 目标2 | 目标3 |
|---|---:|---:|---|
| 震荡 | `1.5R` | `2R` | - |
| 趋势 | `2R` | `3~4R` | 跟踪 |
| 事件 | `1R` | `1.5R` | - |

补充（与 5.5/5.6 对齐）：
- 若下一处关键位/流动性区在 `R` 目标之前，优先以关键位作为目标锚点（先落袋，再谈伸展）。
- 若出现反向 `Liquidity Sweep`（5.6.1）或 `NEWS_RISK=CAUTION`，切换到保守参数：
  - 分批目标乘子：`tp_mult = 0.75`（例如 `2R → 1.5R`）
  - 启用 ATR 跟踪提前：从 `>= 2R` 提前到 `>= 1.5R`
  - 跟踪系数收紧：`ATR×1.0 → ATR×0.8`

分批建议：
- 目标1：平 `40%`，止损移至保本
- 目标2：平 `30%`，止损移至目标1
- 目标3：余仓用 ATR 跟踪

### 7.4 时间止损（避免资金占用与“钝刀割肉”）
| Regime | 最大持仓（K 数） | 规则 |
|---|---:|---|
| 趋势 | 48 | 未达目标1 → 平仓 |
| 震荡 | 12 | 未达目标1 → 平仓 |
| 事件 | 3 | 未达目标1 → 平仓 |

附加：12 根 K 浮亏 → 减仓 50%；24 根 K 在盈亏平衡附近 → 直接离场。

---

## 8. 执行与监控（把“策略正确”变成“可成交的 PnL”）

### 本章与第一性原理的对应
在自动化交易里，PnL 不是“信号对不对”，而是“信号 + 成本 + 可成交性”的合成结果。执行层的第一性原理是：当执行成本不可控时，优势等价于消失；所以必须用监控把执行风险转化为状态机约束，并使其硬生效。

### 8.1 下单类型与滑点保护
| 场景 | 价格锚点 | 保护 |
|---|---|---|
| 限价挂单 | `mid ± 0.05%`（向有利方向） | `depth5` 不足则仓位减半 |
| 市价单 | `mid` | 偏离 `<= 0.15%`；超出则撤单重试 2 次 |

关键位相关的执行细则（与 5.5/5.6 对齐）：
- 止损与挂单统一做“反聚集偏移”：
  - 计算 `cluster_price`：最近的整数位/关键位/前高前低（可配置集合）
  - 若 `|price - cluster_price| <= 2*tick`，则向不利方向偏移 `2*tick`
  - 其余偏移规则由 `band/sweep_margin` 决定（见 5.5.3）

统一撤单规则：
- `3 根 K` 内未成交 → 撤单并使信号过期
- 偏离 `mid > 0.2%` → 自动撤单
- WS/REST 断连或时钟漂移 `> 200ms` → 品种状态 → `HALT`

### 8.2 监控指标（用于状态机与降档）
- 点差、深度、滑点、成交率、行情延迟、mid 更新频率。
- 任何“可观测的异常”优先触发状态机；策略模块必须服从状态机结果。

---

## 9. 冲突决策（用一张“裁判表”结束争吵）

### 本章与第一性原理的对应
机器系统不能“看情况”，必须在冲突时给出唯一动作。第一性原理是把决策空间变成一个有序集合：先满足生存约束与数据/执行约束，再谈策略优先级；否则系统会在同一时刻做出相互抵消或风险叠加的行为。

### 9.1 总优先级
0. **账户级风控**：熔断、回撤、连亏档位  
1. **品种状态机**：`HALT/DEGRADED/NORMAL`  
2. **数据质量**：缺口/异常成交量/延迟  
3. **Regime**：趋势/震荡/过渡（含宏观限制）  
4. **策略模块互斥**：同一时刻同一品种只允许一个方向一个模块  
5. **入场**：信号触发、过滤、价格与挂单规则  
6. **仓位**：风险一致的仓位计算与上限  
7. **出场**：止损/止盈/时间止损  

### 9.2 同品种同刻冲突的裁决
若模块 A 与模块 B 同时触发：
- 技术面 Regime=趋势：优先模块 A；模块 B 禁止逆势。
- 技术面 Regime=震荡：优先模块 B；模块 A 仅允许 0.5 仓位系数且必须顺更高周期。
- 过渡区：只允许 **一个方向**，仓位系数 `<= 0.5`，且必须满足更高周期方向。

---

## 10. 失效检测与迭代（让系统“知道自己不行了”）

### 本章与第一性原理的对应
优势的本质是统计上的非零期望，但市场机制会变化。第一性原理不是“永远有效的参数”，而是：当证据显示优势衰减时，系统要能自动降档/停用，并能把“失效原因”归因到模块、Regime、执行或成本。

### 10.1 规则因果链模板（每条规则必须填写）
| 字段 | 说明 |
|---|---|
| 预期市场行为 | 例如“假突破失败后均值回归” |
| 检测条件 | 指标/形态阈值 + 确认根数 + 数据口径 |
| 执行动作 | 方向、挂单/市价、价格锚点、仓位/杠杆、保护 |
| 失效/降档条件 | 反向破位、指标失效、成交量异常、时间失效、数据异常 |
| 死亡条件 | 最近 100 笔信号触发率过低或期望收益为负 |
| 案例回放 | 自动抽样 ≥ 2-3 个片段，用于定位盈亏与执行偏差（滑点/撤单/延迟） |

### 10.2 最小可执行的失效指标（建议）
- 最近 100 笔信号：胜率、盈亏比、期望收益、最大连续亏损、平均滑点/拒单/撤单率。
- 若“执行成本（滑点+费用）”超过回测假设的 2 倍 → 模块降档或停用并触发校准。

---

## 11. 复盘与日志（自动化：把经验变成数据）

### 本章与第一性原理的对应
自动化系统的学习方式不是“记住感觉”，而是“把每次决策的上下文与结果记录下来”，形成可回放、可统计、可回归测试的数据闭环。日志是把系统从黑盒变为可诊断对象的最低成本手段。

### 11.1 交易日志字段（最小集合）
- 开平仓时间、品种、方向、入场价/止损价/目标、数量/名义/杠杆、触发模块与规则编号
- 当时 `Regime`、品种状态机状态、关键监控指标快照（点差/深度/延迟/滑点）
- 平仓原因（止损/止盈/时间止损/主动）与 `R` 倍数
- 执行评分（1-5）与复盘标签/可行动项（由规则或流水线生成）

### 11.2 分析节奏（建议以定时任务实现）
- 日：生成执行质量报告（成交率/滑点/撤单率/信号是否合规）。
- 周：生成分布报告（胜率/盈亏比/回撤/连续亏损），并按阈值自动触发降档/停用建议。
- 月：生成校准建议（费用/滑点/阈值漂移），并对模块执行“生死判定”。

---

## 12. 参数表（实现时可配置）

### 本章与第一性原理的对应
参数是把“原则”落成“具体动作”的接口。第一性原理要求：参数必须有统一口径、可解释（能回溯到优势/成本/风险约束）、可校准（能通过回测与实盘统计更新），并且改参不会破坏状态机与风控的不变量。

### 12.1 默认参数（建议起点）
- `RISK_TRADE_MAX = 2%`
- `DD_HARD = 25%`
- 执行/流动性阈值建议用 `*_enter/*_exit` 成对定义（见附录 B）：
  - `spread_degrade_enter = 0.08%`, `spread_degrade_exit = 0.06%`
  - `spread_halt_enter = 0.10%`, `spread_halt_exit = 0.08%`
  - `depth5_degrade_enter = 100,000`, `depth5_degrade_exit = 120,000`（USDT 名义）
  - `depth5_halt_enter = 50,000`, `depth5_halt_exit = 70,000`（USDT 名义）
  - `latency_halt_enter = 200ms`, `clock_skew_halt_enter = 200ms`（示例，需按实测校准）
- `slip = 0.10%`（基础保护），`fee = 0.04%`（双边按实际）
- 震荡判定：`ADX < 20`，`bbw < 4%`，均线缠绕 `<1%`
- 成交量/容量（15m/1H 建议启用，见 4.4 与 6.2）：
  - `vol_ma_n_15m = 20`, `vol_ma_n_1H = 20`（用于 `dvol_norm`）
  - `vol_state_q_low = 0.20`, `vol_state_q_high = 0.80`, `vol_state_window_days = 30`
  - `n_adv_days = 30`（计算 `ADV_1H` 的窗口）
  - 参与率上限：`p_limit = 1.0%`, `p_market = 0.5%`（OKX BTC/ETH 起点；低流动性时再下调）

> 这些参数不是“真理”，只是一个一致的起点；必须通过你自己的回测与实盘校准更新。

---

## 13. 适用边界（系统自我约束）

### 本章与第一性原理的对应
系统只能在其假设成立的世界里工作。适用边界就是把“假设何时不成立”写成规则：当流动性、延迟、波动结构或交易所质量脱离假设范围时，系统必须自动收缩或停止，以避免在未知分布下承担不可定价风险。

- 最适合：高流动主流币、点差常态低、盘口深度稳定、API/WS 稳定的环境。
- 不适合：极端低流动长尾、频繁插针、交易所撮合不稳定或延迟无法保证的环境。
- 当 `ADX` 长期很低且 `bbw` 很窄时：模块 A 的趋势优势会显著衰减，应自动降低频率并转向模块 B 或停用。

---

## 附录 E：配置与版本化（上线必需）

### E.1 配置对象（建议拆分）
- `config.runtime`：交易所/账户/路由/限频/环境（prod/paper/backtest）
- `config.market`：品种白名单、合约规格缓存、交易时段（如有）
- `config.params`：所有阈值与自适应开关（遵循附录 C 模板）
- `config.modules`：模块开关、模块参数、优先级与互斥
- `config.risk`：风控与组合约束（第 6 章）

### E.2 版本化与可回滚（必须做到）
- 每次运行必须写入：`config_version`（参数集哈希）+ `git_hash`（代码版本）。
- 参数变更必须支持一键回滚到上一个 `config_version`（包含自适应阈值的基准窗口定义）。
- 线上变更原则：先 `paper/canary`（小仓、少品种）→ 再全量；变更窗口内禁止同时改“信号+执行+风控”三类，以免归因失败。

### E.3 变更验收（最低标准）
- 回测/仿真：指标至少覆盖 `胜率/盈亏比/期望收益/MDD/滑点占比/成交率`，并按 Regime 分桶。
- 实盘（或 paper）：必须输出 `signal->order->fill` 漏斗与执行质量分布；否则不允许扩大仓位上限。

---

## 附录 F：实现验收清单（从 MVP 到可交易）

### F.1 最小可交易（MVP）
- [ ] 口径落地：按附录 A 计算 `spread/depth5/dvol/ADV/latency_md/mid_age/slippage`
- [ ] 状态机落地：按附录 B 转移，具备 hysteresis + 最短保持 + 冷却
- [ ] intent 落地：按附录 D 输出/消费 intent，模块不得直连下单
- [ ] 风控落地：按第 6 章一致口径算仓位（含费用/滑点保护）+ 组合硬约束
- [ ] 执行落地：订单幂等键 + 部分成交处理 + 撤单/重试上限 + 断连安全停机
- [ ] 日志落地：按 D.6 可复现（能还原每笔为什么开/怎么成交/为何出场）

### F.2 可稳定运行（S1）
- [ ] `NEWS_RISK` 全局生效（第 4.3），并与状态机联动
- [ ] 模块 A/B 的 `ttl` 与“未成交过期”一致（第 3.2 / 第 8.1）
- [ ] 失效检测（第 10 章）按 Regime 分桶产出降档/停用建议
- [ ] 参数自适应开关（附录 C.2）可用且可回滚

### F.3 可扩展与可审计（S2）
- [ ] 多交易所/多品种组合风控（第 6.4）与风险簇限制
- [ ] 自动复盘报表（日/周/月，11.2）能定位“优势/执行/成本/风控”中的哪一类问题
- [ ] 关键位与 pivot 的“无前视”实现已被单测覆盖（避免回测污染）

---

## 附录 G：读者自测问题（用于检验文档是否“可读且可执行”）

把本文单独发给一个没参与的人，他/她是否能回答下面问题并给出一致动作？
1. 系统在什么情况下必须“不交易”，这些条件的**唯一口径**在哪里？
2. `NORMAL/DEGRADED/HALT` 分别允许哪些动作？进入与退出的阈值为什么要分 `*_enter/*_exit`？
3. 一个策略模块最少需要输出哪些字段才允许进入风控裁决？如果 `stop_price` 无法定义怎么办？
4. `NEWS_RISK=CAUTION/HALT` 会影响哪些维度（开仓/加仓/仓位系数/出场参数）？
5. 仓位计算的净值口径、成本口径、合约口径分别是什么？USDT 本位与币本位如何避免算错？
6. 如果“信号触发很多但成交很少”，你从哪些日志字段和漏斗指标定位问题？
7. 模块 A 与模块 B 同时触发时，系统如何裁决？组合风控在什么阶段拦截？
8. 关键位/吞没/插针这些信号哪些是“优势来源”，哪些只是“确认/定位”？它们如何被禁用（例如执行不可控）？
9. 哪些指标用于判断模块失效？失效后系统应该做什么（降档/停用/校准）？
10. 如果今天要上线一个最小可交易版本（MVP），清单里最先要实现的 6 件事是什么？

---

## 附录 Z：文档诊断（原文主要问题）

第一性原理写作不是“把规则写全”，而是要保证：每条规则都能回溯到一个可检验的优势来源，并且在边界条件下知道何时停。诊断章节的作用是先把“不可检验、不可执行、不可裁决”的内容暴露出来，避免后续自动化落地时产生不确定性与隐性风险。

1. **标题与内容不匹配**：名为“第一性原理”，正文更多是“规则清单”，缺少从假设 → 可检验边际优势 → 规则/参数的推导链路。
2. **阈值/口径不一致**：例如点差 `0.08%` vs `0.1%`、深度 `5万` vs `10万`、ADX `20` vs `25`、布林带宽 `3%` vs `4%`，导致实盘落地时无法确定“到底听谁的”。
3. **关键公式维度不清**：仓位公式混合了“数量/名义/保证金”的概念，容易在不同合约类型（USDT 本位/币本位/现货）下算错风险。
4. **重复与散落**：数据质量、执行保护、监控降档在多处出现，但没有统一的“系统状态机”，容易遗漏边界情况。
5. **策略模块边界不清**：趋势/均值回归/事件驱动同时存在，但缺少互斥条件、优先级、并发风险与组合约束（例如同一品种同向/反向信号如何裁决）。
6. **可验证性不足**：多数规则缺少“预期行为—验证指标—失败条件—回测/实盘检验方法”的闭环，难以定位失效原因。
