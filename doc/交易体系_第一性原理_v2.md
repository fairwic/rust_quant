# 交易体系（V2：减法 + 连续评分工程版）

> **设计哲学**：
> 1.  **反脆弱**：从“穷举规则消除不确定性”转为“用连续评分与仓位缩放管理不确定性”。
> 2.  **生存优先**：退出通道永远优先于入场逻辑；硬停机仅用于“不可定价/不可退出”的极端场景。
> 3.  **工程闭环**：数据口径唯一、接口定义清晰（Intent）、风控前置。

---

## 0. 核心变更（V1 -> V2）

| 维度 | V1（原版） | V2（当前版） | 优势 |
| :--- | :--- | :--- | :--- |
| **风控逻辑** | 硬阈值（Spread>0.1%即停） | **连续评分**（Spread大→仓位小） | 避免边界闪烁，不错过高波动机会 |
| **状态机** | 复杂嵌套（Regime/Status） | **混合专家**（Trend/Rev 权重分配） | 解耦逻辑，避免死锁 |
| **信号定义** | 复杂的形态确认链 | **最小必要集**（结构+确认） | 降低过拟合，易于归因 |
| **依赖性** | 强依赖外部（日历/OI） | **弱依赖**（价格/量为主，外部降级） | 提高系统鲁棒性 |

---

## 1. 系统第一性原理

### 1.1 交易的三大支柱
1.  **Edge（优势）**：在可控成本下，捕捉**趋势惯性**或**均值回归**的统计正期望。
2.  **Cost（成本）**：以可接受的滑点与手续费完成执行；若成本不可控，优势即消失。
3.  **Survival（生存）**：在极端分布（黑天鹅、脱锚、跑路）下保留本金。

### 1.2 交易对象与框架
- **对象**：OKX BTC/USDT, ETH/USDT（高流动性永续）。
- **Base TF (1H)**：用于定义 Regime、关键位、趋势结构（稳定输入）。
- **Exec TF (15m)**：用于触发入场、计算执行健康度、动态缩放（实时反馈）。

---

## 2. 连续评分体系（Risk & Regime Scoring）

> 所有评分归一化到 `[0, 1]`。`0=Good`, `1=Bad/High Risk`。

### 2.1 执行风险评分 `ExecRiskScore` (15m)
用于**仓位缩放**与**入场保护**。
- **输入**：`spread` (权重0.4), `depth5` (0.3), `latency` (0.3), `slippage` (历史滚动)。
- **计算**：使用分位数 `Rank(current, window=1w)` 进行归一化。
- **作用**：
  - `Scale_Exec = (1 - ExecRiskScore)^2`
  - 若 `ExecRiskScore > 0.8`：禁止市价单，禁止追突破。

### 2.2 市场压力评分 `StressScore` (15m)
用于识别“高波动/不可定价”状态。
- **输入**：`RealizedVol(15m)`, `RangePct`, `FundingRate` 跳变。
- **作用**：
  - 高压（>0.8）：可能是机会也可能是陷阱。策略需切换到 `Conservative` 模式（止盈更近，止损更紧）。

### 2.3 趋势/震荡强度（Regime Weights）
用于**混合专家系统的权重分配**，而非硬切。
- **TrendStrength (1H)**：基于 `ADX`、`EMA` 排列、`BBW` 扩张度。
- **MeanRevStrength (1H)**：基于 `BBW` 收敛、均线缠绕度。
- **分配**：`w_trend` 与 `w_meanrev` 归一化后决定两类策略的预算比例。

---

## 3. 策略模块（最小必要信号集）

### 3.1 模块 A：趋势跟随 (Trend Following)
**逻辑**：趋势惯性。
**启用权重**：`w_trend`。

#### A1. 结构定义 (1H)
- **多头排列**：`EMA144 > EMA169 > EMA576` 且 `Slope(EMA576) > 0`。
- **空头排列**：反之。
- **失效**：均线缠绕或 `ADX < 20`（此时 `TrendStrength` 自然降低，无需硬开关）。

#### A2. 入场 Setup
1.  **Pullback (回调)**：价格回踩 `EMA144-169` 区域 + 15m 出现**确认信号**（Engulfing/Pinbar）。
2.  **Breakout (突破)**：突破关键阻力位（Swing High） + `VolScore` 健康（放量） + `StressScore` 适中（非极端脉冲）。

#### A3. 出场
- **止损**：`Swing Low` (结构) 或 `ATR*2` (波动率)。
- **止盈**：
  - T1 (40%): `2R` 或前高。
  - T2 (60%): `Trailing Stop` (ATR*1.5 跟踪)。

### 3.2 模块 B：均值回归 (Mean Reversion)
**逻辑**：流动性衰竭与假突破。
**启用权重**：`w_meanrev`。

#### B1. 结构定义 (1H)
- **主要场景**：价格触及 `Bollinger Band` 上下轨 或 关键支撑阻力位。
- **过滤**：若 `TrendStrength > 0.8`（强趋势中），严禁逆势。

#### B2. 入场 Setup
- **False Breakout (假突破)**：
  1.  突破关键位/布林轨。
  2.  收盘价**收回**关键位内（15m）。
  3.  **确认**：反向吞没或长影线（Wick > Body）。
  4.  **缩放**：若 `VolScore` 极低（无量），大幅降低仓位。

#### B3. 出场
- **止损**：极窄。`Swing High/Low + Buffer`。若止损过宽则放弃交易（盈亏比不划算）。
- **止盈**：均值回归至 `EMA21` 或 `Bollinger Mid`。

---

## 4. 风控与执行体系（预算制）

### 4.1 动态仓位计算（核心公式）
不再使用固定仓位，而是基于当前环境缩放：

```python
# 1. 基础风险预算
Base_Risk_Pct = 0.02  # 2%

# 2. 连续评分缩放 (Score 越小越好)
Scale_Env = (1 - StressScore) * (1 - ExecRiskScore)
Scale_Regime = w_module_strength  # 当前策略的适应度

# 3. 最终单笔风险
Risk_Valid = Base_Risk_Pct * Scale_Env * Scale_Regime

# 4. 数量计算 (USDT本位)
Dist = abs(Entry - Stop) + Slippage_Buffer + Fee
Qty = (Equity * Risk_Valid) / Dist

# 5. 硬约束 (Cap)
Notional = Qty * Entry
Limit_Liquidity = p * ADV_1H  # 流动性上限
Limit_Account = Equity * Max_Lev
Final_Qty = min(Qty, Limit_Liquidity / Entry, Limit_Account / Entry)
```

### 4.2 紧急模式与硬停机 (HARD HALT)
仅在以下情况触发**硬停机**（禁止开仓，允许 Reduce-Only）：
1.  **数据毒化**：`Source_Mid` 与 `Oracle_Price` 偏差 `> 3%`（防插针/操控）。
2.  **脱锚风险**：`USDT` 价格偏离 `> 2%`。
3.  **设施崩溃**：`Latency > 3s` 或 `WS` 断连超过阈值。
4.  **死锁逃生**：连续 `N` 次撤单/拒单。

> **注意**：硬停机时，止损单（Stop Loss）不应被撤销，应升级为“市价/激进限价”以确保能离场。

---

## 5. 附录 A：统一数据口径（Spec）

| 指标 | 标准定义 | 说明 |
| :--- | :--- | :--- |
| `mid` | `(bid1 + ask1) / 2` | 基础定价锚 |
| `spread` | `(ask1 - bid1) / mid` | 成本评估 |
| `dvol` | `Quote Volume (USDT)` | 优先用交易所 Quote Vol，否则 `Vol * Mid` |
| `ADV_1H` | `MA(dvol_1H, 30*24)` | 30日平均小时成交额，用于容量限制 |
| `EMA_Structure` | `144, 169, 576` | 斐波那契均线组，用于定义趋势 |
| `ATR` | `ATR(14)` | 用于波动率归一化和止损宽窄 |
| `Slippage` | `abs(Fill_Px - Decision_Mid) / Decision_Mid` | 包含延迟造成的滑点 |

---

## 6. 附录 B：Intent 接口定义（开发规范）

所有策略模块不直接下单，而是输出 `Intent` 结构体：

```rust
struct TradeIntent {
    module_id: String,      // "Trend_A", "Rev_B"
    side: Side,             // Long/Short
    setup_type: SetupType,  // Pullback, Breakout, Fakeout
    
    // 价格相关
    entry_anchor: PriceAnchor, // Mid, EMA_Band, Level_12345
    stop_loss_anchor: PriceAnchor, // 必需，无止损不交易
    take_profit_plan: TpPlan,      // R倍数或关键位
    
    // 信号元数据
    signal_score: f64,      // 0.0-1.0，模块内部信心
    ttl_bars: usize,        // 有效期，过期作废
    
    // 依赖检查
    required_regime: RegimeType, 
    min_exec_score: f64,
}
```

---

## 7. 落地路线图

1.  **基础设施**：实现 `ExecRiskScore` 和 `StressScore` 的实时计算与记录。
2.  **风控层**：实现“预算缩放公式”与“硬停机”逻辑。
3.  **策略层**：
    - 先上 **模块 A (Trend Pullback)**：最稳健，容易验证。
    - 后上 **模块 B (Mean Rev)**：处理震荡市。
4.  **资产风控**：接入 Oracle 价格监控（可先mock）。
